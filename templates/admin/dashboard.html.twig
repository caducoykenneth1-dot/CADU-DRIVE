{% extends 'admin/layout.html.twig' %}

{% block admin_title %}Admin Dashboard{% endblock %}

{% block admin_content %}
    {% set stats = stats|default({}) %}
    {% set nowDate = date() %}

    <div class="admin-dashboard">
        {% for message in app.flashes('success') %}
            <div class="alert-success">{{ message }}</div>
        {% endfor %}
        <section id="overview" class="dashboard-section" data-dashboard-section>
            <div class="dashboard-hero">
                <div>
                    <p class="dashboard-eyebrow">Control Center</p>
                    <h1 class="dashboard-heading">Operations Dashboard</h1>
                    <p class="dashboard-subheading">
                        Monitor customers, fleet health, and rental activity without leaving this page.
                        Use the quick actions to jump straight into the work that matters today.
                    </p>
                </div>
                <div class="dashboard-hero-actions">
                    <a href="{{ path('app_car_new') }}" class="dashboard-action">
                        <span class="bi bi-car-front-fill"></span>
                        Add Vehicle
                    </a>
                    <a href="{{ path('app_rental_index') }}" class="dashboard-action">
                        <span class="bi bi-calendar2-week"></span>
                        Manage Rentals
                    </a>
                </div>
            </div>

            <div class="dashboard-stat-grid">
                <article class="dashboard-stat-card">
                    <p>Total Customers</p>
                    <h3>{{ stats.totalCustomers ?? 0 }}</h3>
                    <span>{{ stats.newCustomersThisMonth ?? 0 }} new this month</span>
                </article>
                <article class="dashboard-stat-card">
                    <p>Fleet Size</p>
                    <h3>{{ stats.totalCars ?? 0 }}</h3>
                    <span>Utilization {{ stats.fleetUtilization ?? 0 }}%</span>
                </article>
                <article class="dashboard-stat-card">
                    <p>Active Rentals</p>
                    <h3>{{ stats.activeRentals ?? 0 }}</h3>
                    <span>{{ stats.totalRentals ?? 0 }} total bookings</span>
                </article>
                <article class="dashboard-stat-card">
                    <p>Next Return</p>
                    {% set nextReturn = stats.nextReturn ?? null %}
                    {% if nextReturn %}
                        {% set nextReturnCar = nextReturn.car ?? null %}
                        {% set nextReturnCustomer = nextReturn.customer ?? null %}
                        <h3>{{ nextReturn.endDate|date('M d') }}</h3>
                        <span>
                            {{ nextReturnCar ? nextReturnCar.make ~ ' ' ~ nextReturnCar.model : 'Vehicle' }}
                            &middot;
                            {{ nextReturnCustomer ? nextReturnCustomer.displayName : 'Customer' }}
                        </span>
                    {% else %}
                        <h3>--</h3>
                        <span>No upcoming return scheduled</span>
                    {% endif %}
                </article>
            </div>
        </section>

        <section id="customers" class="dashboard-section" data-dashboard-section>
            <div class="section-header">
                <div>
                    <h2>Latest Customers</h2>
                    <p>Fresh signups ready to be verified and welcomed.</p>
                </div>
                <div class="section-actions">
                    <a href="{{ path('app_customer_index') }}" class="section-link">
                        <span class="bi bi-people"></span>
                        Manage Customers
                    </a>
                </div>
            </div>

            {% if recentCustomers is not empty %}
                <div class="dashboard-table-wrapper">
                    <table class="dashboard-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Contact</th>
                                <th>Phone</th>
                                <th>Joined</th>
                                <th>Rentals</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in recentCustomers %}
                                <tr>
                                    <td>
                                        {{ customer.displayName }}
                                        {% if customer.notes %}
                                            <span class="subtle">Notes: {{ customer.notes|length > 80 ? customer.notes|slice(0, 80) ~ '...' : customer.notes }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="mailto:{{ customer.email }}" class="text-blue-300 hover:underline">
                                            {{ customer.email }}
                                        </a>
                                    </td>
                                    <td>{{ customer.phone|default('N/A') }}</td>
                                    <td>{{ customer.createdAt ? customer.createdAt|date('M d, Y') : 'N/A' }}</td>
                                    <td>{{ customer.rentals|length }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-placeholder">
                    <strong>No customers yet</strong>
                    Once customers register or are created manually they will appear here automatically.
                </div>
            {% endif %}
        </section>

        <section id="fleet" class="dashboard-section" data-dashboard-section>
            <div class="section-header">
                <div>
                    <h2>Fleet Snapshot</h2>
                    <p>Recently updated vehicles and their current availability.</p>
                </div>
            </div>

            {% if fleetSnapshot is not empty %}
                <div class="fleet-grid">
                    {% for car in fleetSnapshot %}
                        {% set status = car.status ?? null %}
                        {% set statusCode = status ? status.code|default('')|lower : '' %}
                        {% set badgeClass = statusCode == 'available' ? 'is-green' : (statusCode in ['maintenance', 'service'] ? 'is-amber' : 'is-slate') %}
                        <article class="fleet-card">
                            <div class="fleet-card-header">
                                <h3>{{ car.make }} {{ car.model }}</h3>
                                <span class="status-badge {{ badgeClass }}">
                                    {{ status ? status.label : 'Unassigned' }}
                                </span>
                            </div>
                            <div class="fleet-card-meta">
                                <span><span class="bi bi-calendar3"></span> {{ car.year }}</span>
                                <span><span class="bi bi-cash-stack"></span> &#8369;{{ car.price|number_format(2, '.', ',') }}/day</span>
                                <span><span class="bi bi-diagram-3"></span> {{ car.rentals|length }} rentals</span>
                            </div>
                            {% set lastRental = car.rentals|last %}
                            <div class="fleet-card-footer">
                                <span>Car ID #{{ car.id }}</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-400">
                                        Last booking {{ lastRental ? lastRental.endDate|date('M d, Y') : 'N/A' }}
                                    </span>
                                    <a href="{{ path('app_car_edit', { id: car.id }) }}" class="section-link">
                                        <span class="bi bi-pencil-square"></span>
                                        Edit
                                    </a>
                                    <form method="post" action="{{ path('app_car_delete', { id: car.id }) }}" class="inline-delete-form">
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ car.id) }}">
                                        <button type="button"
                                                class="section-link section-link-danger confirm-delete-btn"
                                                data-confirm-title="Delete this vehicle?"
                                                data-confirm-text="This vehicle and its related rentals will be removed. This action cannot be undone."
                                                data-confirm-button="Yes, Delete It">
                                            <span class="bi bi-trash"></span>
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-placeholder">
                    <strong>No vehicles recorded</strong>
                    Add your first car to start building out the fleet roster.
                </div>
            {% endif %}
        </section>

        <section id="rentals" class="dashboard-section" data-dashboard-section>
            <div class="section-header">
                <div>
                    <h2>Rental Timeline</h2>
                    <p>Latest bookings with quick visibility into status and key dates.</p>
                </div>
                <div class="section-actions">
                    <a href="{{ path('app_rental_index') }}" class="section-link">
                        <span class="bi bi-calendar-event"></span>
                        View All Rentals
                    </a>
                </div>
            </div>

            {% if recentRentals is not empty %}
                <div class="timeline">
                    {% for rental in recentRentals %}
                        {% set isActive = rental.startDate <= nowDate and rental.endDate >= nowDate %}
                        {% set isUpcoming = rental.startDate > nowDate %}
                        <div class="timeline-item">
                            <span class="timeline-dot"></span>
                            <div class="timeline-content">
                                <h4>{{ rental.car.make }} {{ rental.car.model }}</h4>
                                <p>
                                    <span class="bi bi-person"></span>
                                    {{ rental.customer.displayName }}
                                </p>
                                <div class="meta">
                                    <span>
                                        <span class="bi bi-clock"></span>
                                        {{ rental.startDate|date('M d, Y') }} to {{ rental.endDate|date('M d, Y') }}
                                    </span>
                                    <span>
                                        {% if isActive %}
                                            <span class="status-badge is-green">Active</span>
                                        {% elseif isUpcoming %}
                                            <span class="status-badge is-amber">Upcoming</span>
                                        {% else %}
                                            <span class="status-badge is-slate">Completed</span>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-placeholder">
                    <strong>No rentals recorded</strong>
                    Once bookings are created they will appear on the timeline.
                </div>
            {% endif %}
        </section>
    </div>
{% endblock %}
