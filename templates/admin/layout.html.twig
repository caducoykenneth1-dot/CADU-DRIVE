{% extends 'base.html.twig' %}

{% block title %}{% if block('admin_title') is defined %}{{ block('admin_title') }}{% else %}Admin Panel{% endif %}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/dashboard.css') }}">
{% endblock %}

{% block body %}
    <div class="flex min-h-screen bg-gray-900 text-gray-200">
        <div id="admin-drawer-overlay" class="fixed inset-0 hidden bg-black/50 backdrop-blur-sm lg:hidden"></div>
       
        {%if is_granted('ROLE_ADMIN') %}
        <aside id="admin-drawer" class="admin-drawer admin-drawer-closed fixed inset-y-0 left-0 z-40 flex w-64 flex-col overflow-y-auto border-r border-gray-800 bg-gray-900 py-10 shadow-lg lg:static lg:z-10 lg:h-auto lg:py-8 lg:shadow-none">
            <div class="px-6 pb-4">
                <h2 class="text-lg font-semibold uppercase tracking-wide text-gray-400">Admin Menu</h2>
            </div>
            {% else %}
            <aside id="admin-drawer" class="admin-drawer admin-drawer-closed fixed inset-y-0 left-0 z-40 flex w-64 flex-col overflow-y-auto border-r border-gray-800 bg-gray-900 py-10 shadow-lg lg:static lg:z-10 lg:h-auto lg:py-8 lg:shadow-none">
            <div class="px-6 pb-4">
                <h2 class="text-lg font-semibold uppercase tracking-wide text-gray-400">Staff Menu</h2>
            </div>
        {% endif %}

           <nav class="flex-1 space-y-1 px-4 pb-6">
    {# Dashboard visible to both Admin and Staff #}
       {% if is_granted('ROLE_ADMIN') %}
    <a href="{{ path('app_admin_dashboard') }}" data-section="dashboard"
    class="admin-nav-link"  > <span class="bi bi-people text-base"></span>
    Admin Dashboard</a>
{% elseif is_granted('ROLE_STAFF') %}
    <a href="{{ path('app_staff_dashboard') }}" data-section="dashboard" 
    class="admin-nav-link">  <span class="bi bi-people text-base"></span>Staff Dashboard</a>
{% endif %}

    {# Only Admin can see Customers #}
    {% if is_granted('ROLE_ADMIN')or is_granted('ROLE_STAFF') %}
        <a href="{{ path('app_admin_customer') }}" 
           data-section="customers" 
           class="admin-nav-link {{ 'app_customer_index' == app.request.attributes.get('_route') ? 'is-active' : '' }}">
           <span class="bi bi-people text-base"></span> Customers
        </a>
    {% endif %}

   {# NEW: Manage Staff - ADMIN ONLY #}
   {% if is_granted('ROLE_ADMIN') %}
<a href="{{ path('app_staff_overview') }}" 
   data-section="staff"
   class="admin-nav-link {{ 'staff_crud' in app.request.attributes.get('_route') ? 'is-active' : '' }}">
    <span class="bi bi-person-gear text-base"></span>
    Manage Staff
</a>
    {% endif %}


    {# Cars: Admin and Staff can see #}
    {% if is_granted('ROLE_ADMIN' )  %}
        <a href="{{ path('app_admin_cars') }}" 
           data-section="cars" 
           class="admin-nav-link {{ 'app_admin_cars' == app.request.attributes.get('_route') ? 'is-active' : '' }}">
           <span class="bi bi-car-front text-base"></span> Cars
        </a>
    {% endif %}

                {# Rental Requests - For Staff to manage customer requests #}
    {% if is_granted('ROLE_ADMIN') %}
        {# Admin gets VIEW-ONLY page #}
        <a href="{{ path('app_admin_rental_requests_view') }}" 
           data-section="rental-requests" 
           class="admin-nav-link">
           <span class="bi bi-clipboard-check text-base"></span> Rental Requests (View)
        </a>
    {% elseif is_granted('ROLE_STAFF') %}
        {# Staff gets MANAGEMENT page #}
        <a href="{{ path('app_staff_rental_requests') }}" 
           data-section="rental-requests" 
           class="admin-nav-link">
           <span class="bi bi-clipboard-check text-base"></span> Rental Requests (Online)
        </a>
    {% endif %}
  
   {% if is_granted('ROLE_STAFF') and not is_granted('ROLE_ADMIN') %}
    <a href="{{ path('app_walk_in_rental_index') }}"
       data-section="walk-in-rental"
       class="admin-nav-link">
        <span class="bi bi-clipboard-check text-base"></span>
        Walk-In Rental
    </a>
{% endif %}


            <form action="{{ path('app_logout') }}" method="post" class="pt-4 border-t border-gray-800 mt-4">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token('logout') }}">
    <button type="submit" class="admin-nav-link w-full text-left hover:text-red-400 transition-colors">
        <span class="bi bi-box-arrow-right text-base"></span> Logout 
    </button>
</form>


                <a href="{{ path('app_home') }}" class="admin-nav-link"> Back to Home</a>
            </nav>
        </aside>

        <div class="flex flex-1 flex-col">
            <header class="flex items-center justify-between border-b border-gray-800 bg-gray-900/70 px-6 py-4 lg:hidden">
                <button id="admin-drawer-open" class="inline-flex items-center rounded-md border border-gray-700 px-3 py-2 text-sm font-medium text-gray-200 transition hover:bg-gray-800">
                    <span class="bi bi-list mr-2 text-lg"></span>
                    Menu
                </button>
                <span class="text-sm font-medium text-gray-400">Admin Panel</span>
                <span></span>
            </header>

            <main class="flex-1 bg-gray-900 px-6 py-8 lg:ml-64 relative z-20 admin-main--offset">
                {% block admin_content %}{% endblock %}
            </main>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        (function () {
            const drawer = document.getElementById('admin-drawer');
            const overlay = document.getElementById('admin-drawer-overlay');
            const openBtn = document.getElementById('admin-drawer-open');
            let closeMobileDrawer = null;

            if (!drawer || !overlay || !openBtn) {
                return;
            }

            const closeDrawer = () => {
                drawer.classList.add('admin-drawer-closed');
                overlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            };

            const openDrawer = () => {
                drawer.classList.remove('admin-drawer-closed');
                overlay.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            };

            closeMobileDrawer = closeDrawer;

            openBtn.addEventListener('click', openDrawer);
            overlay.addEventListener('click', closeDrawer);

            const sectionLinks = Array.from(drawer.querySelectorAll('[data-section]'));
            const sections = Array.from(document.querySelectorAll('[data-dashboard-section]'));

            const activateLink = (id) => {
                sectionLinks.forEach((link) => {
                    if (link.dataset.section === id) {
                        link.classList.add('is-active');
                    } else {
                        link.classList.remove('is-active');
                    }
                });
            };

            sectionLinks.forEach((link) => {
                link.addEventListener('click', (event) => {
                    const targetId = link.dataset.section;
                    const targetSection = document.getElementById(targetId);
                    if (!targetSection) {
                        return;
                    }

                    event.preventDefault();
                    if (typeof closeMobileDrawer === 'function') {
                        closeMobileDrawer();
                    }
                    targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    activateLink(targetId);
                });
            });

            if ('IntersectionObserver' in window && sections.length > 0) {
                const observer = new IntersectionObserver(
                    (entries) => {
                        const visible = entries
                            .filter((entry) => entry.isIntersecting)
                            .sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];

                        if (visible) {
                            activateLink(visible.target.id);
                        }
                    },
                    {
                        rootMargin: '-45% 0px -45% 0px',
                        threshold: [0.1, 0.35, 0.6],
                    }
                );

                sections.forEach((section) => observer.observe(section));
            }

            if (sectionLinks.length > 0) {
                const firstSection = sectionLinks[0].dataset.section;
                if (firstSection) {
                    activateLink(firstSection);
                }
            }
        }());
    </script>
{% endblock %}
