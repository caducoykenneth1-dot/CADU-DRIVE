{% extends 'admin/layout.html.twig' %}

{# Stylesheets: keep parent styles and admin dashboard CSS if present #}
{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/dashboard.css') }}">
{% endblock %}

{# Main admin content block #}
{% block admin_content %}

    {% block admin_title %}Manage Customers{% endblock %}

    {# Normalize the incoming collection: support `recentCustomers` or `customers` #}
    {% set list = recentCustomers is defined ? recentCustomers : (customers is defined ? customers : []) %}

    <section id="customers" class="px-4 py-6">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                <div class="mb-4 sm:mb-0">
                    <h1 class="text-2xl font-semibold text-gray-100">Customers</h1>
                    <p class="text-sm text-gray-400">All customer profiles and recent activity.</p>
                </div>

                <div class="flex items-center gap-3">
                    <a href="{{ path('app_customer_register') }}" class="inline-flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Add
                    </a>
                    <a href="{{ path('app_customer_index') }}" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded">
                        Refresh
                    </a>
                </div>
            </div>

            <div class="mb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div class="w-full sm:w-1/2">
                    <label for="customer-search" class="sr-only">Search customers</label>
                    <input id="customer-search" type="search" placeholder="Search by name, email or phone" class="w-full bg-gray-900 border border-gray-800 text-gray-200 placeholder-gray-500 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>

                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-400">Showing</span>
                    <span class="inline-block bg-gray-800 text-gray-200 text-sm py-1 px-2 rounded">{{ list|length }}</span>
                </div>
            </div>

            <div class="customer-table mb-6">
                <table class="min-w-full text-sm" aria-describedby="customers-description">
                    <caption id="customers-description" class="sr-only">List of registered customers</caption>
                    <thead>
                        <tr>
                            <th class="px-4 py-3 text-left">Customer</th>
                            <th class="px-4 py-3 text-left">Email</th>
                            <th class="px-4 py-3 text-left">Phone</th>
                            <th class="px-4 py-3 text-left">Joined</th>
                            <th class="px-4 py-3 text-left">Rentals</th>
                            <th class="px-4 py-3 text-right">Actions</th>
                        </tr>
                    </thead>

                    <tbody id="customers-tbody">
                        {% if list is not empty %}
                            {% for customer in list %}
                                <tr data-name="{{ (customer.displayName|default(customer.firstName ~ ' ' ~ customer.lastName))|lower|e('html_attr') }}" data-email="{{ (customer.email|default(''))|lower|e('html_attr') }}" data-phone="{{ (customer.phone|default(''))|e('html_attr') }}">
                                    <td class="px-4 py-3">
                                        <a href="{{ path('app_customer_show', {'id': customer.id}) }}" class="customer-name">
                                            <span class="avatar" aria-hidden="true" style="display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:50%;background:#0ea5e9;color:#04263a;margin-right:0.75rem;font-weight:700;">{{ (customer.firstName|default('')|first|upper) ~ (customer.lastName|default('')|first|upper) }}</span>
                                            <span>
                                                <div>{{ customer.displayName|default(customer.firstName ~ ' ' ~ customer.lastName) }}</div>
                                                {% if customer.notes %}
                                                    <div class="customer-created">{{ customer.notes|length > 60 ? customer.notes|slice(0,60) ~ '...' : customer.notes }}</div>
                                                {% endif %}
                                            </span>
                                        </a>
                                    </td>

                                    <td class="px-4 py-3">
                                        {% if customer.email %}
                                            <a href="mailto:{{ customer.email }}" class="text-blue-300 hover:underline">{{ customer.email }}</a>
                                        {% else %}
                                            <span class="tag tag-muted">N/A</span>
                                        {% endif %}
                                    </td>

                                    <td class="px-4 py-3">{{ customer.phone|default('N/A') }}</td>

                                    <td class="px-4 py-3">{{ customer.createdAt ? customer.createdAt|date('M d, Y') : 'N/A' }}</td>

                                    <td class="px-4 py-3">{{ customer.rentals is defined ? customer.rentals|length : '0' }}</td>

                                    <td class="px-4 py-3 text-right">
                                        <div class="inline-flex items-center" style="gap:0.5rem;">
                                            <a href="{{ path('app_customer_show', {'id': customer.id}) }}" class="btn btn-compact btn-details">View</a>
                                            <a href="{{ path('app_customer_edit', {'id': customer.id}) }}" class="btn btn-compact btn-edit">Edit</a>

                                            <form method="post" action="{{ path('app_customer_delete', {'id': customer.id}) }}" class="delete-form--customer" onsubmit="return confirm('Are you sure you want to delete this customer?');">
                                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ customer.id) }}">
                                                <button type="submit" class="btn-delete" aria-label="Delete {{ customer.displayName|default(customer.firstName ~ ' ' ~ customer.lastName) }}">
                                                    <span class="bi bi-trash"></span>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="px-4 py-6 text-center text-gray-400">No customers found.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    {# Client-side search: light, debounced, works for small to medium lists. #}
    {% block javascripts %}
        {{ parent() }}
        <script>
            (function(){
                const input = document.getElementById('customer-search');
                if (!input) return;
                const tbody = document.getElementById('customers-tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                let timer = null;

                function matchRow(row, term) {
                    if (!term) return true;
                    term = term.toLowerCase();
                    const name = row.dataset.name || '';
                    const email = row.dataset.email || '';
                    const phone = row.dataset.phone || '';
                    return name.includes(term) || email.includes(term) || phone.includes(term);
                }

                input.addEventListener('input', function(e){
                    clearTimeout(timer);
                    const val = e.target.value.trim().toLowerCase();
                    timer = setTimeout(()=>{
                        rows.forEach(r => {
                            r.style.display = matchRow(r, val) ? '' : 'none';
                        });
                    }, 150);
                });
            })();
        </script>
    {% endblock %}

{% endblock %}